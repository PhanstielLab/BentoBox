#' extracts HiC data from .hic file using Straw
#'
#'
#' @param hic path to .hic file
#' @param chrom chromosome of desired region
#' @param chromstart start position
#' @param chromend end position
#' @param resolution the width of each pixel; "auto" will attempt to choose a resolution (in basepairs) based on the size of the region
#' @param zrange the range of interaction scores to plot, where extreme values will be set to the max or min; if null, zrange will be set to (0, max(data))
#' @param norm hic data normalization; must be found in hic file
#' @param res_scale resolution scale; options are "BP" and "FRAG"
#' @param assembly desired genome assembly
#' @param altchrom if looking at region between two different chromosomes, this is the specified alternative chromosome
#' @param altchromstart if looking at region between two different chromosomes, start position of altchrom
#' @param altchromend if looking at region between two different chromsomes, end position of altchrom
#'
#' @return Function will return a 3-column dataframe
#'
#' @export

bb_readHic <- function(hic, chrom, chromstart = NULL, chromend = NULL, resolution = "auto", zrange = NULL,
                       norm = "KR", res_scale = "BP", assembly = "hg19", altchrom = NULL, altchromstart = NULL, altchromend = NULL){


  # ======================================================================================================================================================================================
  # FUNCTIONS
  # ======================================================================================================================================================================================

  ## Define a function that catches errors for bb_rhic
  errorcheck_bb_rhic <- function(hic, chromstart, chromend, zrange, altchrom, altchromstart, altchromend, norm, res_scale){

    ## hic input needs to be a path to a .hic file
    if (class(hic) != "character"){

      stop("Invalid input. Input needs to be a path to a .hic file.", call. = FALSE)

    }

    if ((file_ext(hic) != "hic")){

      stop("Invalid input. File must have a \".hic\" extension", call. = FALSE)

    }

    if (!file.exists(hic)){

      stop(paste("File", hic, "does not exist."), call. = FALSE)
    }

    ## Can't have only one NULL chromstart or chromend
    if ((is.null(chromstart) & !is.null(chromend)) | (is.null(chromend) & !is.null(chromstart))){

      stop("Cannot have one \'NULL\' \'chromstart\' or \'chromend\'.", call. = FALSE)

    }

    if (!is.null(chromstart) & !is.null(chromend)){

      ## Chromstart should be smaller than chromend
      if (chromstart > chromend){

        stop("\'chromstart\' should not be larger than \'chromend\'.", call. = FALSE)

      }

    }

    if (!is.null(altchrom)){

      ## Can't specify altchrom without a chrom
      if (is.null(chrom)){

        stop("Specified \'altchrom\', but did not give \'chrom\'.", call. = FALSE)

      }

      ## Can't have only one NULL altchromstart or altchromend
      if ((is.null(altchromstart) & !is.null(altchromend)) | (is.null(altchromend) & !is.null(altchromstart))){

        stop("Cannot have one \'NULL\' \'altchromstart\' or \'altchromend\'.", call. = FALSE)

      }
      ## Altchromstart should be smaller than altchromend

      if (altchromstart > altchromend){

        stop("\'altchromstart\' should not be larger than \'altchromend\'.", call. = FALSE)

      }

      ## If giving same chrom and altchrom, need to specify chromstart/chromend and altchromstart/altchromend

      if (chrom == altchrom){

        if (is.null(chromstart) | is.null(chromend) | is.null(altchromstart) | is.null(altchromend)){

          stop("If giving the same \'chrom\' and \'altchrom\', please specify \'chromstart\', \'chromend\', \'altchromstart\', and \'altchromend\'.
               If trying to get all interactions between one chromosome, just specify \'chrom\'.", call. = FALSE)

        }

      }

    }

    ## Ensure properly formatted zrange
    if (!is.null(zrange)){

      ## zrange needs to be a vector
      if (!is.vector(zrange)){

        stop("\'zrange\' must be a vector of length 2.", call. = FALSE)

      }

      ## zrange vector needs to be length 2
      if (length(zrange) != 2){

        stop("\'zrange\' must be a vector of length 2.", call. = FALSE)

      }

      ## zrange vector needs to be numbers
      if (!is.numeric(zrange)){

        stop("\'zrange\' must be a vector of two numbers.", call. = FALSE)

      }

      ## second value should be larger than the first value
      if (zrange[1] >= zrange[2]){

        stop("\'zrange\' must be a vector of two numbers in which the 2nd value is larger than the 1st.", call. = FALSE)

      }

    }


    ## Check for valid "res_scale" parameter
    if(!(res_scale %in% c("BP", "FRAG"))){

      stop("Invalid \'res_scale\'.  Options are \'BP\' and \'FRAG\'.", call. = FALSE)

    }

  }

  ## Define a function that determines a best resolution for size of region
  auto_resolution <- function(chromstart, chromend){

    if (is.null(chromstart) & is.null(chromend)){
      autoRes <- 500000
    } else {
      dataRange <- chromend - chromstart
      if (dataRange >= 150000000){
        autoRes <- 500000
      } else if (dataRange >= 75000000 & dataRange < 150000000){
        autoRes <- 250000
      } else if (dataRange >= 35000000 & dataRange < 75000000){
        autoRes <- 100000
      } else if (dataRange >= 20000000 & dataRange < 35000000){
        autoRes <- 50000
      } else if (dataRange >= 5000000 & dataRange < 20000000){
        autoRes <- 25000
      } else if (dataRange >= 3000000 & dataRange < 5000000){
        autoRes <- 10000
      } else {
        autoRes <- 5000
      }
    }

    return(as.integer(autoRes))

  }

  ## Define a function to parse chromsome/region for Straw
  parse_region <- function(chrom, chromstart, chromend, assembly){

    if (assembly == "hg19"){
      strawChrom <- as.numeric(gsub("chr", "", chrom))
    }


    if (is.null(chromstart) & is.null(chromend)){

      regionStraw <- strawChrom

    } else {

      ## Keep chromstart and chromend without scientific notation for processing with Straw

      chromstart <- format(chromstart, scientific = FALSE)
      chromend <- format(chromend, scientific = FALSE)
      regionStraw <- paste(strawChrom, chromstart, chromend, sep = ":")

    }

    return(regionStraw)

  }

  ## Define a function to scale data with zrange
  scale_data <- function(upper, zrange){

    if (!is.null(zrange)){

      upper$counts[upper$counts <= zrange[1]] <- zrange[1]
      upper$counts[upper$counts >= zrange[2]] <- zrange[2]

    } else {

      #if null, zrange will be set to (0, max(data))
      upper$counts[upper$counts <= 0] <- 0

    }

    return(upper)

  }

  ## Define a function to rename columns
  rename_columns <- function(upper, chrom, altchrom){

    if (is.null(altchrom)){

      colnames(upper) <- c(chrom, chrom, "counts")

    } else {

      colnames(upper) <- c(chrom, altchrom, "counts")

    }

    return(upper)
  }

  # ======================================================================================================================================================================================
  # CATCH ERRORS
  # ======================================================================================================================================================================================

  errorcheck_bb_rhic(hic = hic, chromstart = chromstart, chromend = chromend, zrange = zrange, altchrom = altchrom, altchromstart = altchromstart,
                     altchromend = altchromend, norm = norm, res_scale = res_scale)

  # ======================================================================================================================================================================================
  # SET PARAMETERS
  # ======================================================================================================================================================================================
  parse_chromstart <- chromstart
  parse_chromend <- chromend
  parse_altchromstart <- altchromstart
  parse_altchromend <- altchromend


  ## For off diagonal plotting, grabbing whole symmetric region
  if (!is.null(altchrom)){

    if (chrom == altchrom){

      parse_chromstart <- min(chromstart, altchromstart)
      parse_chromend <- max(chromend, altchromend)

    }

  }

  # ======================================================================================================================================================================================
  # PARSE REGIONS
  # ======================================================================================================================================================================================

  chromRegion <- parse_region(chrom = chrom, chromstart = parse_chromstart, chromend = parse_chromend, assembly = assembly)

  if (is.null(altchrom)){

    altchromRegion <- chromRegion

  } else {

    if (chrom == altchrom){

      altchromRegion <- chromRegion

    } else {

      altchromRegion <- parse_region(chrom = altchrom, chromstart = parse_altchromstart, chromend = parse_altchromend, assembly = assembly)

    }

  }

  # ======================================================================================================================================================================================
  # ADJUST RESOLUTION
  # ======================================================================================================================================================================================

  if (resolution == "auto"){
    resolution <- auto_resolution(chromstart = chromstart, chromend = chromend)
    res_scale <- "BP"
  }

  # ======================================================================================================================================================================================
  # EXTRACT SPARSE UPPER TRIANGULAR USING STRAW
  # ======================================================================================================================================================================================

  upper <- strawr::straw(norm, hic, toString(chromRegion), toString(altchromRegion), res_scale, resolution)

  # ======================================================================================================================================================================================
  # REORDER COLUMNS BASED ON CHROM/ALTCHROM INPUT
  # ======================================================================================================================================================================================
  if (!is.null(altchrom)){
    numberChrom <- as.numeric(gsub("chr|[A-Z]", "", chrom))
    numberaltChrom <- as.numeric(gsub("chr|[A-Z]", "", altchrom))

    if (numberChrom > numberaltChrom){

      upper <- upper[, c(2, 1, 3)]
      colnames(upper) <- c("x", "y", "counts")

    }

  }

  # ======================================================================================================================================================================================
  # SCALE DATA WITH ZRANGE
  # ======================================================================================================================================================================================

  scaled_data <- scale_data(upper = upper, zrange = zrange)

  # ======================================================================================================================================================================================
  # FORMAT DATA IN PROPER ORDER AND WITH LABELS
  # ======================================================================================================================================================================================

  renamed_data <- rename_columns(upper = scaled_data, chrom = chrom, altchrom = altchrom)

  # ======================================================================================================================================================================================
  # REMOVE NAN VALUES
  # ======================================================================================================================================================================================

  renamed_data <- na.omit(renamed_data)

  # ======================================================================================================================================================================================
  # RETURN DATAFRAME
  # ======================================================================================================================================================================================
  if (nrow(renamed_data) == 0){

    warning("Warning: no data found in region.  Suggestions: check chromosome, check region.", call. = FALSE)
  }

  message(paste("Read in hic file with", norm, "normalization at", resolution, res_scale, "resolution."))
  return(renamed_data)
}
